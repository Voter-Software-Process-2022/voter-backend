name: Production Deployment

on:
  workflow_run:
    workflows: ["Tests"]
    branches: [main]
    types:
      - completed

concurrency:
  group: ${{ github.ref_name }}
  cancel-in-progress: true

jobs:
  deploy:
    name: Deploy Production
    runs-on: ubuntu-latest
    steps:
      - name: Install Deta CLI
        shell: bash
        run: |
          curl -fsSL https://get.deta.dev/cli.sh | sh
      - name: Clone Deta Metadata
        shell: bash
        run: |
          export DETA_ACCESS_TOKEN=${{ secrets.DETA_TOKEN }}
          cd ./src
          ~/.deta/bin/deta clone --name ${{ github.event.repository.name }} --project ${{ secrets.DETA_PROJECT }} tmp/
          cp -r tmp/.deta .
      - name: Deploy to Deta
        shell: bash
        run: |
          export DETA_ACCESS_TOKEN=${{ secrets.DETA_TOKEN }}
          cd ./src
          ~/.deta/bin/deta deploy
      - name: Make envfile
        uses: SpicyPizza/create-envfile@v1.3
        with:
          envkey_WEBHOOK_ID: ${{secrets.WEBHOOK_ID}}
          envkey_WEBHOOK_TOKEN: ${{secrets.WEBHOOK_TOKEN}}
          envkey_HEALTHCHECK_NAME: ${{env.text}}